---
title: "ARIMA R/Quarto Pipeline"
author: "Farooq Mahmud"
format: html
editor: source
---

## Load time series

```{r}
data <- read.csv(file.path(getwd(), "../data", "time_series.csv"))
data$pickup_date <- as.Date(data$pickup_date)
data <- data[order(data$pickup_date), ]

h <- 14          # 14-day forecast (same period as LSTM for comparison)
VAL_DAYS <- 30   # match LSTM: 30 validation + 14 test held out

# Training series: same as LSTM (first 322 days; then 30 validation + 14 test)
n_train <- nrow(data) - VAL_DAYS - h
ts_data_train <- ts(data$avg_duration_min[1:n_train], frequency = 366, start = c(2024, 1))
```

## Full-year time series graph

```{r}
library(ggplot2)

ggplot(data, aes(x = pickup_date, y = avg_duration_min)) +
  geom_line() +
  labs(
    title = "Daily Average Uber Trip Duration (2024)",
    x = "Date",
    y = "Average Duration (minutes)"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  theme_minimal()
```

## Model Selection
```{r}
library(forecast)
auto_fit <- auto.arima(ts_data_train)
auto_fit
```

## 14-Day Forecast
```{r}
# Forecast 44 steps (validation + test) so last 14 match LSTM test period
forecast_result <- forecast(auto_fit, h = VAL_DAYS + h)
```

## Table of Forecasted Values
```{r}
# Same 14-day period as LSTM (last 14 days of 2024) for fair comparison
forecast_full <- as.data.frame(forecast_result)
# Use last 14 of the 44-step forecast (steps 31:44 = LSTM test period)
forecast_summary <- forecast_full[(VAL_DAYS + 1):(VAL_DAYS + h), ]
forecast_dates <- data$pickup_date[(nrow(data) - h + 1):nrow(data)]

# Save forecast to CSV for comparison with LSTM

formatted_forecast <- cbind(Date = forecast_dates, forecast_summary)

formatted_forecast <- within(formatted_forecast, {
  `Point Forecast` <- round(`Point Forecast`, 2)
  `Lo 80` <- round(`Lo 80`, 2)
  `Hi 80` <- round(`Hi 80`, 2)
  `Lo 95` <- round(`Lo 95`, 2)
  `Hi 95` <- round(`Hi 95`, 2)
})

arima_forecast_df <- data.frame(
  date = forecast_dates,
  actual = data$avg_duration_min[(nrow(data) - h + 1):nrow(data)],
  forecast = formatted_forecast$`Point Forecast`
)

print(formatted_forecast)

write.csv(arima_forecast_df, file.path(getwd(), "../data", "arima_forecast_14day.csv"), row.names = FALSE)
```

## 14-Day Forecast with Intervals (plot)

```{r}
# Historical data (up to start of forecast period)
hist_df <- data.frame(
  date = data$pickup_date[1:n_train],
  value = data$avg_duration_min[1:n_train]
)

# Forecast period: point forecast and intervals (last 14 of 44-step forecast)
fc_df <- data.frame(
  date = forecast_dates,
  point = forecast_summary$`Point Forecast`,
  lo80  = forecast_summary$`Lo 80`,
  hi80  = forecast_summary$`Hi 80`,
  lo95  = forecast_summary$`Lo 95`,
  hi95  = forecast_summary$`Hi 95`
)

# Actuals for the 14-day window (for overlay)
actual_14 <- data.frame(
  date = forecast_dates,
  actual = data$avg_duration_min[(nrow(data) - h + 1):nrow(data)]
)

ggplot() +
  geom_line(data = hist_df, aes(x = date, y = value), color = "gray40", linewidth = 0.6) +
  geom_ribbon(data = fc_df, aes(x = date, ymin = lo95, ymax = hi95), fill = "steelblue", alpha = 0.2) +
  geom_ribbon(data = fc_df, aes(x = date, ymin = lo80, ymax = hi80), fill = "steelblue", alpha = 0.3) +
  geom_line(data = fc_df, aes(x = date, y = point), color = "steelblue", linewidth = 0.9) +
  geom_point(data = fc_df, aes(x = date, y = point), color = "steelblue", size = 2) +
  geom_line(data = actual_14, aes(x = date, y = actual), color = "#332288", linewidth = 0.7) +
  geom_point(data = actual_14, aes(x = date, y = actual), color = "#332288", size = 2) +
  labs(
    title = "ARIMA 14-Day Forecast with 80% and 95% Prediction Intervals",
    x = "Date",
    y = "Avg trip duration (minutes)"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Evaluation: sMAPE and MASE

```{r}
library(Metrics)
library(yardstick)

train_vals <- data$avg_duration_min[1:n_train]
mae_train <- mean(abs(diff(train_vals)))

# Metrics::smape returns proportion; multiply by 100 for percentage
arima_smape <- Metrics::smape(arima_forecast_df$actual, arima_forecast_df$forecast) * 100

arima_mase <- yardstick::mase_vec(
  truth = arima_forecast_df$actual,
  estimate = arima_forecast_df$forecast,
  m = 1,
  mae_train = mae_train
)

cat("ARIMA sMAPE (%):", round(arima_smape, 4), "\n")
cat("ARIMA MASE:", round(arima_mase, 4), "\n")
```